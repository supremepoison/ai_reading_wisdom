<!--pages/home/home.wxml - é¦–é¡µæ‰“å¡-->
<view class="container">
  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view wx:if="{{isRegistered}}">
    <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-card card flex items-center justify-between">
      <view class="flex items-center">
        <view class="flame-icon">
          <image src="/assets/icons/flame.svg" mode="aspectFit" class="icon-md"/>
        </view>
        <view class="streak-info">
          <text class="text-small">è¿ç»­é˜…è¯»</text>
          <view class="streak-value">
            <text class="text-title">{{streak}}</text>
            <text class="text-small"> å¤©</text>
          </view>
        </view>
      </view>
      <view class="points-badge flex items-center">
        <image src="/assets/icons/star.svg" mode="aspectFit" class="icon-sm"/>
        <text class="points-text">{{userPoints}}</text>
      </view>
    </view>

    <!-- ä»Šæ—¥ä»»åŠ¡å¡ç‰‡ -->
    <view class="section-header flex items-center justify-between">
      <text class="text-title">ä»Šæ—¥ä»»åŠ¡</text>
      <view class="chapter-badge">
        <text>ç¬¬ {{currentBook.chapterNumber}}/{{currentBook.totalChapters}} å›</text>
      </view>
    </view>
    
    <view class="mission-card">
      <!-- èƒŒæ™¯è£…é¥° -->
      <view class="mission-bg-circle"></view>
      
      <view class="mission-content flex">
        <image src="{{currentBook.coverUrl}}" mode="aspectFill" class="book-cover"/>
        <view class="book-info flex-1">
          <text class="book-title">{{currentBook.title}}</text>
          <text class="book-author">{{currentBook.author}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{currentBook.progress}}%"></view>
          </view>
          <text class="progress-text">å·²è¯» {{currentBook.progress}}%</text>
        </view>
      </view>
      
      <view class="chapter-panel">
        <text class="chapter-title">{{currentBook.currentChapter}}</text>
        
        <view wx:if="{{!checkedInToday}}" class="action-buttons-grid">
          <view class="checkin-btn quick-btn" bindtap="handleQuickCheckIn">
            <text class="btn-icon">âš¡ï¸</text>
            <text class="btn-text">å¿«é€Ÿæ‰“å¡</text>
            <text class="btn-points">+1</text>
          </view>
          <view class="checkin-btn photo-btn" bindtap="handlePhotoCheckIn">
            <text class="btn-icon">ğŸ“¸</text>
            <text class="btn-text">æ‹ç…§æ‰“å¡</text>
            <text class="btn-points">+2</text>
          </view>
          <view class="checkin-btn voice-btn" bindtap="handleVoiceCheckIn"
                bindtouchstart="startRecording" bindtouchmove="handleTouchMove" bindtouchend="stopRecording">
            <text class="btn-icon">ğŸ¤</text>
            <text class="btn-text">{{isRecording ? 'æ¾å¼€ç»“æŸ' : 'è¯­éŸ³æ‰“å¡'}}</text>
            <text class="btn-points">+3</text>
          </view>
        </view>
        
        <view wx:else class="completed-msg">
          <text class="success-icon">âœ…</text>
          <text>ä»Šæ—¥æ‰“å¡å·²å®Œæˆ</text>
        </view>
      </view>
    </view>

    <!-- å½•éŸ³çŠ¶æ€æç¤º -->
    <view wx:if="{{isRecording}}" class="recording-overlay">
      <view class="recording-box {{willCancel ? 'cancel-style' : ''}}">
        <view class="recording-wave" wx:if="{{!willCancel}}"></view>
        <view class="cancel-icon" wx:if="{{willCancel}}">â†©ï¸</view>
        <text class="recording-text">{{willCancel ? 'æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€' : 'æ­£åœ¨å½•éŸ³... ä¸Šæ»‘å–æ¶ˆ'}}</text>
      </view>
    </view>

    <!-- æ—¥å†æ‰“å¡è®°å½• -->
    <view class="card calendar-card">
      <view class="calendar-header flex items-center justify-between">
        <view class="flex items-center">
          <image src="/assets/icons/calendar.svg" mode="aspectFit" class="icon-sm"/>
          <text class="text-title" style="margin-left: 16rpx;">æˆ‘çš„è¶³è¿¹</text>
        </view>
        <text class="month-display">{{currentMonthDisplay}}</text>
      </view>
      
      <!-- æ˜ŸæœŸè¡¨å¤´ -->
      <view class="weekday-header">
        <text wx:for="{{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']}}" wx:key="*this">{{item}}</text>
      </view>

      <view class="calendar-grid">
        <view
          wx:for="{{calendarDays}}"
          wx:key="index"
          class="calendar-day {{item.status}}"
        >
          <text>{{item.day}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view wx:else class="auth-gate">
    <view class="auth-gate-card animate-pop">
      <text class="auth-gate-icon">ğŸ“š</text>
      <text class="auth-gate-title">æ¬¢è¿æ¥åˆ°æ™ºæ…§ä¹‹åŒ™</text>
      <text class="auth-gate-desc">AI é˜…è¯»ä¼´ä¾£ï¼Œè®°å½•æ‚¨çš„æ¯ä¸€æ¬¡æˆé•¿</text>
      <view class="auth-gate-buttons">
        <button class="auth-gate-btn primary" bindtap="goToRegister">æ–°å­¦å‘˜æ³¨å†Œ</button>
        <button class="auth-gate-btn secondary" bindtap="handleLogin">è€å­¦å‘˜ç™»å½•</button>
      </view>
    </view>
  </view>
  <!-- é€‰ä¹¦å¼¹çª— -->
  <view wx:if="{{showBookPicker && isRegistered}}" class="book-picker-overlay">
    <view class="book-picker-container animate-pop">
      <view class="picker-header">
        <text class="picker-title">å¼€å¯æ™ºæ…§ä¹‹æ—…</text>
        <text class="picker-subtitle">æ ¹æ®æ‚¨çš„ç­‰çº§ï¼Œä¸ºæ‚¨æ¨èä»¥ä¸‹ä¹¦ç±</text>
      </view>
      <scroll-view scroll-y class="book-shelf" style="max-height: 60vh;">
        <view 
          wx:for="{{recommendBooks}}" 
          wx:key="_id" 
          class="recommend-book-item"
          bindtap="handleSelectBook"
          data-id="{{item._id}}"
        >
          <image src="{{item.cover_url}}" mode="aspectFill" class="recommend-cover"/>
          <view class="recommend-info">
            <text class="recommend-title">{{item.title}}</text>
            <text class="recommend-author">{{item.author}}</text>
            <view class="level-tag">æ¨èç­‰çº§: LV.{{item.recommend_level}}</view>
          </view>
          <view class="select-btn">å¼€å·</view>
        </view>
      </scroll-view>
      <view class="picker-footer">
        <text class="picker-tip">å…ˆè¯»ä¸€æœ¬å¥½ä¹¦ï¼Œæ˜¯æˆé•¿çš„å¼€å§‹</text>
      </view>
    </view>
  </view>
</view>

<!-- æ‰“å¡æˆåŠŸåŠ¨ç”»å¼¹çª— -->
<view wx:if="{{showAnimation}}" class="success-overlay">
  <view class="success-modal animate-pop">
    <text class="success-emoji animate-float">ğŸŒŸ</text>
    <text class="success-title">å¤ªæ£’å•¦!</text>
    <view class="success-points">
      <text>+{{earnedPoints}} ç§¯åˆ†</text>
    </view>
  </view>
</view>
