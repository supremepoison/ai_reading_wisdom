<!--pages/profile/profile.wxml - ä¸ªäººä¸­å¿ƒ-->
<block wx:if="{{isRegistered}}">
  <view class="container">
    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆæ— å¤´åƒï¼Œåå­—ç‰¹æ•ˆï¼‰ -->
    <view class="profile-header">
      <text class="greeting-emoji">ğŸ‘‹</text>
      <view class="name-row">
        <text class="user-name-fancy">{{userInfo.name || 'æœªå‘½å'}}</text>
        <view class="edit-name-btn" bindtap="openEditModal">
          <text>âœï¸</text>
        </view>
      </view>
      <view class="user-badges">
        <view class="level-badge">
          <text wx:if="{{levelNames.length > 0}}">LV.{{userInfo.level || 1}} {{levelNames[(userInfo.level || 1) - 1]}}</text>
          <text wx:else>LV.{{userInfo.level || 1}} åŠ è½½ä¸­...</text>
        </view>
      </view>
      
      <!-- ç®¡ç†å‘˜å…¥å£ -->
      <view wx:if="{{userInfo.role === 'admin'}}" class="admin-entry" bindtap="navigateToAdmin">
        <text>ğŸ‘‘ ç”¨æˆ·ç®¡ç†</text>
      </view>
    </view>

    <!-- æ•°æ®ç»Ÿè®¡ -->
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{userInfo.points || 0}}</text>
        <text class="stat-label">æ€»ç§¯åˆ†</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{userInfo.continuous_days || 0}}</text>
        <text class="stat-label">è¿ç»­æ‰“å¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{readingHistory.length || 0}}</text>
        <text class="stat-label">æ­£åœ¨é˜…è¯»</text>
      </view>
    </view>

    <!-- å‹‹ç« å¢™ -->
    <view class="section">
      <view class="section-header">
        <image src="/assets/icons/award.svg" mode="aspectFit" class="section-icon"/>
        <text class="section-title">å‹‹ç« å¢™</text>
      </view>
      <view class="medal-wall card">
        <view 
          wx:for="{{medals}}" 
          wx:key="id"
          class="medal-item"
        >
          <view class="medal-icon {{item.achieved ? 'medal-achieved' : 'medal-locked'}}">
            <text>{{item.icon}}</text>
          </view>
          <text class="medal-name {{item.achieved ? '' : 'medal-name-locked'}}">{{item.name}}</text>
        </view>
      </view>
    </view>

    <!-- é˜…è¯»æ¡£æ¡ˆ -->
    <view class="section">
      <view class="section-header flex justify-between items-center">
        <text class="section-title">é˜…è¯»æ¡£æ¡ˆ</text>
        <view class="discover-btn" bindtap="openBookPicker">
          <text>æŒ‘é€‰æ–°ä¹¦</text>
        </view>
      </view>
      <view class="reading-list">
        <view 
          wx:for="{{readingHistory}}" 
          wx:key="title"
          class="reading-item"
        >
          <image src="{{item.coverUrl}}" class="reading-cover" mode="aspectFill"/>
          <view class="reading-info">
            <text class="reading-title">{{item.title}}</text>
            <view class="reading-tags">
              <view class="tag {{item.status === 'reading' ? 'tag-green' : 'tag-gray'}}">
                <text>{{item.status === 'reading' ? 'æ­£åœ¨é˜…è¯»' : 'å·²è¯»å¾…ç»­'}}</text>
              </view>
              <view class="tag tag-blue">
                <text>{{item.notesCount}} ç¯‡æ„Ÿæ‚Ÿ</text>
              </view>
            </view>
          </view>
          <!-- åˆ‡æ¢ä¹¦ç±æŒ‰é’®ï¼šä»…å½“ä¸æ˜¯å½“å‰æ­£åœ¨è¯»çš„ä¹¦æ—¶æ˜¾ç¤º -->
          <view wx:if="{{item.status !== 'reading'}}" 
                class="switch-book-btn" 
                catchtap="handleSwitchBook" 
                data-id="{{item.bookId}}">
            <text>åˆ‡æ¢é˜…è¯»</text>
          </view>
        </view>
      </view>
    </view>

    <!-- é€‰ä¹¦å¼¹çª—ï¼ˆæœ¬é¡µå†…å¼¹å‡ºï¼‰ -->
    <view wx:if="{{showBookPicker}}" class="book-picker-overlay" catchtap="closeBookPicker">
      <view class="book-picker-container animate-pop" catchtap="">
        <view class="picker-header">
          <text class="picker-title">åˆ‡æ¢ä¹¦ç±</text>
          <text class="picker-subtitle">é€‰æ‹©åå½“å‰ä¹¦ç±è¿›åº¦ä¼šè‡ªåŠ¨ä¿å­˜</text>
        </view>
        <scroll-view scroll-y class="book-shelf">
          <view 
            wx:for="{{recommendBooks}}" 
            wx:key="_id" 
            class="recommend-book-item"
            catchtap="handlePickBook"
            data-id="{{item._id}}"
          >
            <image src="{{item.cover_url}}" mode="aspectFill" class="recommend-cover"/>
            <view class="recommend-info">
              <text class="recommend-title">{{item.title}}</text>
              <text class="recommend-author">{{item.author}}</text>
              <view class="level-tag">æ¨èç­‰çº§: LV.{{item.recommend_level}}</view>
            </view>
            <view class="select-btn">å¼€å·</view>
          </view>
        </scroll-view>
        <view class="picker-footer">
          <view class="close-picker-btn" bindtap="closeBookPicker">
            <text>å–æ¶ˆ</text>
          </view>
        </view>
      </view>
    </view>
  <!-- ç¼–è¾‘ä¸ªäººä¿¡æ¯å¼¹çª— -->
  <view wx:if="{{showEditModal}}" class="edit-overlay" catchtap="closeEditModal">
    <view class="edit-modal animate-pop" catchtap="stopPropagation">
      <view class="edit-modal-header">
        <text class="edit-modal-title">ç¼–è¾‘ä¸ªäººä¿¡æ¯</text>
      </view>
      <view class="edit-form">
        <view class="edit-form-item">
          <text class="edit-label">å§“å</text>
          <input class="edit-input" value="{{editName}}" bindinput="onEditNameInput" placeholder="è¯·è¾“å…¥å§“å" />
        </view>
        <view class="edit-form-item">
          <text class="edit-label">æ‰‹æœºå·</text>
          <input class="edit-input" type="number" value="{{editPhone}}" bindinput="onEditPhoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11" />
        </view>
      </view>
      <view class="edit-modal-footer">
        <view class="edit-cancel-btn" bindtap="closeEditModal"><text>å–æ¶ˆ</text></view>
        <view class="edit-save-btn" bindtap="saveProfile"><text>ä¿å­˜</text></view>
      </view>
    </view>
  </view>
  </view>
</block>

<view wx:else class="auth-loading-placeholder">
  <view class="loading-spinner"></view>
</view>
