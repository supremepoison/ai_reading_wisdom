<!--pages/chat/chat.wxml - AI èŠå¤©å¯¼è¯»-->
<block wx:if="{{isRegistered}}">
  <view class="chat-container">
    <!-- ä¸Šä¸‹æ–‡æç¤º -->
    <view class="context-pill">
      <view class="context-pill-inner">
        <image src="/assets/icons/book.svg" mode="aspectFit" class="icon-xs"/>
        <text>æ­£åœ¨è®¨è®º: {{currentBook.title}}</text>
      </view>
    </view>

    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <scroll-view 
      class="chat-messages" 
      scroll-y="true" 
      scroll-into-view="{{scrollToView}}"
      scroll-with-animation="true"
    >
      <view 
        wx:for="{{messages}}" 
        wx:key="id"
        id="msg-{{item.id}}"
        class="message-wrapper {{item.role === 'user' ? 'user-message' : 'ai-message'}}"
      >
        <!-- AI å¤´åƒï¼ˆå·¦ä¾§ï¼‰ -->
        <view wx:if="{{item.role !== 'user'}}" class="avatar ai-avatar">
          <image src="/assets/icons/brain.svg" mode="aspectFit"/>
        </view>

        <!-- æ¶ˆæ¯æ°”æ³¡ -->
        <view class="message-bubble {{item.role === 'user' ? 'bubble-user' : 'bubble-ai'}}">
          <text user-select="true" wx:if="{{!item.plan}}">{{item.text}}</text>
          <text user-select="true" wx:if="{{item.plan}}">âœ… å­¦ä¹ è®¡åˆ’å·²ç»ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹ï¼š</text>

          <!-- è®¡åˆ’å¡ç‰‡ -->
          <view wx:if="{{item.type === 'plan' && item.plan}}" class="plan-card">
            <view class="plan-header">
              <text class="plan-title">{{item.plan.plan_name || 'å­¦ä¹ è®¡åˆ’'}}</text>
            </view>
            <view class="plan-strategy" wx:if="{{item.plan.strategy}}">
              <text>ğŸ’¡ {{item.plan.strategy}}</text>
            </view>
            <view class="plan-tasks">
              <view class="plan-task-item" wx:for="{{item.plan.daily_tasks}}" wx:for-item="task" wx:key="day">
                <view class="task-day">{{task.day}}</view>
                <view class="task-detail">
                  <text class="task-name">{{task.task}}</text>
                  <text class="task-time">{{task.estimated_time}}</text>
                </view>
              </view>
            </view>
            <view class="plan-actions" wx:if="{{!item.plan.accepted}}">
              <button class="btn-action confirm-btn" bindtap="handleConfirmPlan" data-plan="{{item.plan}}" data-msgid="{{item.id}}">æ¥å—æ­¤è®¡åˆ’</button>
              <button class="btn-action adjust-btn" bindtap="handleAdjustPlan" data-msgid="{{item.id}}">è¿™æœ‰ç‚¹éš¾ï¼Œèƒ½è°ƒæ•´å—ï¼Ÿ</button>
            </view>
            <view class="plan-accepted-msg" wx:else>
              <text>âœ… å·²æ¥å—è¯¥è®¡åˆ’ï¼Œæˆ‘ä¼šåœ¨æ¥ä¸‹æ¥çš„æ—¥å­é™ªä½ ä¸€èµ·å®Œæˆï¼</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½ä¸­çŠ¶æ€ -->
      <view wx:if="{{isLoading}}" class="message-wrapper ai-message">
        <view class="avatar ai-avatar">
          <image src="/assets/icons/brain.svg" mode="aspectFit"/>
        </view>
        <view class="message-bubble bubble-ai loading-bubble">
          <view class="loading-dots">
            <view class="dot dot-1"></view>
            <view class="dot dot-2"></view>
            <view class="dot dot-3"></view>
          </view>
        </view>
      </view>
      
      <!-- å ä½ï¼Œç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ -->
      <view id="msg-bottom" style="height: 20rpx;"></view>
    </scroll-view>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <view class="input-area">
      <button class="voice-btn btn-reset" bindtap="handleVoice" style="width: 64rpx">
        <image src="/assets/icons/mic.svg" mode="aspectFit"/>
      </button>
      
      <input 
        class="message-input"
        value="{{inputText}}"
        bindinput="onInputChange"
        bindconfirm="handleSend"
        placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
        placeholder-class="input-placeholder"
        confirm-type="send"
      />
      
      <button 
        class="send-btn btn-reset {{inputText ? 'send-active' : ''}}" 
        bindtap="handleSend"
        disabled="{{!inputText || isLoading}}"
        style="width: 64rpx"
      >
        <image src="/assets/icons/send.svg" mode="aspectFit"/>
      </button>
    </view>
  </view>
</block>

<!-- æœªç™»å½•ç©ºç™½ä½ -->
<view wx:else class="auth-loading-placeholder">
  <view class="loading-spinner"></view>
</view>
