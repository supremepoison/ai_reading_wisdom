# 智慧之匙 整体测试计划

> 测试日期：2026-02-15
> 预计耗时：30-45 分钟

---

## 🔧 测试前准备

### 1. 确认云函数已全部上传

在微信开发者工具中，**右键 → 上传并部署：云端安装依赖**，确认以下 13 个云函数均已部署：

| # | 云函数名 | 说明 | 是否新增/修改 |
|---|---------|------|------------|
| 1 | `login` | 自动登录 | — |
| 2 | `registerUser` | 注册 | — |
| 3 | `checkin` | 打卡 | ⚠️ 修改 |
| 4 | `getCheckinLogs` | 日历数据 | — |
| 5 | `getUserCurrentTask` | 当前任务/进度 | ⚠️ 修改 |
| 6 | `getUserStats` | 个人统计 | ⚠️ 修改 |
| 7 | `getUserArchive` | 阅读档案 | ⚠️ 修改 |
| 8 | `getRecommendBooks` | 推荐书籍 | 🆕 新增 |
| 9 | `selectBook` | 选书/切换 | 🆕 新增 |
| 10 | `chatWithAI` | AI 对话 | — |
| 11 | `generateNote` | 生成感悟 | ⚠️ 修改 |
| 12 | `generateNoteQuestions` | 引导问题 | — |
| 13 | `generateQuiz` | 生成闯关题 | — |
| 14 | `submitQuiz` | 提交闯关结果 | 🆕 新增 |
| 15 | `getConfig` | 全局配置 | — |
| 16 | `getUsers` | 管理后台 | — |
| 17 | `updateUserLevel` | 修改等级 | — |

### 2. 确认数据库集合已创建

在云开发控制台 → 数据库中，确认以下 10 个集合存在：

```
users, books, user_progress, checkins, quiz_records,
notes, dialogs, questions, note_questions, config
```

### 3. 填入 books 测试数据

在 `books` 集合中添加至少 2 条记录（参考 `scripts/mock_db_data.md`）：

**书籍 1：**
```json
{
  "title": "西游记",
  "author": "吴承恩",
  "cover_url": "https://picsum.photos/id/24/200/280",
  "total_chapters": 5,
  "recommend_level": 1,
  "chapters": [
    "第一回：灵根育孕源流出",
    "第二回：悟彻菩提真妙理",
    "第三回：四海千山皆拱伏",
    "第四回：官封弼马心何足",
    "第五回：乱蟠桃大圣偷丹"
  ]
}
```

**书籍 2：**
```json
{
  "title": "三国演义",
  "author": "罗贯中",
  "cover_url": "https://picsum.photos/id/42/200/280",
  "total_chapters": 5,
  "recommend_level": 1,
  "chapters": [
    "第一回：宴桃园豪杰三结义",
    "第二回：张翼德怒鞭督邮",
    "第三回：议温明董卓叱丁原",
    "第四回：废汉帝陈留践位",
    "第五回：发矫诏诸镇应曹公"
  ]
}
```

### 4. 填入 config 测试数据

在 `config` 集合中添加 1 条记录：

```json
{
  "key": "level_config",
  "levels": [
    { "level": 1, "name": "阅读萌新", "min_points": 0 },
    { "level": 2, "name": "阅读学徒", "min_points": 100 },
    { "level": 3, "name": "阅读达人", "min_points": 500 },
    { "level": 4, "name": "阅读大师", "min_points": 1000 },
    { "level": 5, "name": "阅读宗师", "min_points": 3000 }
  ]
}
```

---

## 📋 测试用例

### 测试 1：新用户注册（首次使用）

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 1.1 | 清除模拟器缓存，打开小程序 | 显示欢迎页，有"新学员注册"和"老学员登录"按钮 | ☐ |
| 1.2 | 点击"新学员注册" | 跳转到注册页面 | ☐ |
| 1.3 | 输入姓名，点击"创建资料" | 提示注册成功，自动跳回首页 | ☐ |
| 1.4 | 检查数据库 `users` 集合 | 新增一条记录，含 `openid`, `name`, `role: 'student'`, `points: 0` | ☐ |

---

### 测试 2：首次选书

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 2.1 | 注册完成回到首页 | 自动弹出"开启智慧之旅"选书弹窗，列出书籍 | ☐ |
| 2.2 | 点击"西游记"旁的"开卷" | 弹窗消失，显示提示"书籍开启成功" | ☐ |
| 2.3 | 观察今日任务卡片 | 显示书名"西游记"、"第 1/5 回"、进度 20% | ☐ |
| 2.4 | 检查数据库 `user_progress` | 新增一条记录：`book_name: "西游记"`, `status: "reading"`, `current_chapter_index: 0` | ☐ |

---

### 测试 3：打卡功能

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 3.1 | 点击"⚡️ 快速打卡" | 弹出成功动画，显示"+10 积分" | ☐ |
| 3.2 | 观察页面变化 | 打卡按钮消失，显示"✅ 今日打卡已完成" | ☐ |
| 3.3 | 观察任务卡片 | 进度变为"第 2/5 回"，进度条前进 | ☐ |
| 3.4 | 观察日历 | 今天的日期格子高亮 | ☐ |
| 3.5 | 检查数据库 `checkins` | 新增一条记录：`date_str` 为今天, `points_earned: 10` | ☐ |
| 3.6 | 刷新页面 | 仍显示"✅ 今日打卡已完成"，不可再次打卡 | ☐ |

---

### 测试 4：切换书籍 + 防刷验证

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 4.1 | 切换到"个人中心" Tab | 个人中心正常加载 | ☐ |
| 4.2 | 在"阅读档案"中点击"挑选新书" | 本页弹出选书弹窗，列出书籍 | ☐ |
| 4.3 | 选择"三国演义" | 弹窗关闭，提示切换成功 | ☐ |
| 4.4 | 切回首页 | 显示"三国演义"、"第 1/5 回"，打卡按钮重新出现 | ☐ |
| 4.5 | 再次快速打卡 | 成功打卡，但**积分不增加**（防刷生效） | ☐ |
| 4.6 | 检查数据库 `users` | `points` 不变（仍是之前的值） | ☐ |
| 4.7 | 检查进度 | "三国演义"仍为"第 1/5 回"，章节**不推进**（防刷生效） | ☐ |

---

### 测试 5：个人中心 - 阅读档案

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 5.1 | 进入个人中心 | 显示用户名、等级(LV.1 阅读萌新)、积分、连续打卡天数 | ☐ |
| 5.2 | 查看阅读档案区域 | 列出 2 本书：三国演义(正在阅读)、西游记(已读待续) | ☐ |
| 5.3 | 西游记旁边有"切换阅读"按钮 | 按钮显示，样式为琥珀色 | ☐ |
| 5.4 | 点击"切换阅读" | 切换回西游记，提示成功 | ☐ |

---

### 测试 6：AI 对话

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 6.1 | 从首页进入"书灵对话" | 聊天页面打开，显示当前书名 | ☐ |
| 6.2 | 发送一条消息（如"孙悟空为什么大闹天宫"） | AI 返回回复，流式显示 | ☐ |
| 6.3 | 检查数据库 `dialogs` | 新增对话记录 | ☐ |

---

### 测试 7：智能笔记

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 7.1 | 从首页进入"感悟笔记" | 显示引导问题（AI 生成） | ☐ |
| 7.2 | 选择一个问题，回答后点击"生成感悟" | AI 生成一段读书感悟 | ☐ |
| 7.3 | 保存感悟 | 提示保存成功，积分 +30 | ☐ |
| 7.4 | 检查数据库 `notes` | 新增一条感悟记录 | ☐ |

---

### 测试 8：闯关答题

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 8.1 | 从首页进入"闯关" | 加载题目（可能需等待 AI 生成） | ☐ |
| 8.2 | 完成全部题目 | 跳转到结果页，显示得分 | ☐ |
| 8.3 | 检查数据库 `quiz_records` | 新增一条闯关记录，含分数 | ☐ |
| 8.4 | 检查数据库 `users` | 积分增加（答对的积分） | ☐ |

---

### 测试 9：管理后台（可选）

| 步骤 | 操作 | 预期结果 | 通过? |
|-----|------|---------|------|
| 9.1 | 在数据库中将自己的 `role` 改为 `"admin"` | — | ☐ |
| 9.2 | 刷新小程序，进入个人中心 | 出现"👑 用户管理"入口 | ☐ |
| 9.3 | 点击进入用户管理 | 显示用户列表 | ☐ |
| 9.4 | 修改某用户等级 | 更新成功 | ☐ |

---

## 🐛 Bug 记录表

| # | 页面 | 描述 | 严重程度 | 备注 |
|---|------|------|---------|------|
| 1 | | | | |
| 2 | | | | |
| 3 | | | | |

---

## ✅ 测试完成确认

- [ ] 全部 P0 功能通过
- [ ] 全部 P1 功能通过
- [ ] Bug 记录完毕
- [ ] 准备进入 P2 功能开发
